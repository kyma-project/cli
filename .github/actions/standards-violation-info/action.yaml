name: 'Standards Violation Info'
description: 'Action for adding comment to current PR about violated standards'

inputs:
  validation_failed:
    description: 'Whether the validation has passed'
    required: true
  github_token:
    description: 'GitHub token'
    required: true

runs:
  using: 'composite'
  steps:
    - name: comment
      run: |
        FLAGS=""

        # Determine which message to post based on validation result
        if [ "${{ inputs.validation_failed }}" = "true" ]; then
          echo "Standards violation detected"
          FLAGS="${FLAGS} --body-file .github/actions/standards-violation-info/violation-message.md"
        else
          echo "No standards violation detected"
          FLAGS="${FLAGS} --body-file .github/actions/standards-violation-info/no-violation-message.md"
        fi

        # Check for existing comment by github-actions and edit if found
        LAST_COMMENT_ID=$(gh pr view ${{ github.event.pull_request.number }} -R kyma-project/cli --json "comments" \
          | jq --raw-output '.comments[] | select(.author.login=="github-actions") | .id')
        if [ -n "$LAST_COMMENT_ID" ]; then
          echo "Editing last comment with ID: $LAST_COMMENT_ID"
          FLAGS="${FLAGS} --edit-last"
        fi

        gh pr comment ${{ github.event.pull_request.number }} -R kyma-project/cli $FLAGS
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      shell: bash
