name: 'Standards Violation Info'
description: 'Action for verifying and adding comment to current PR about violated standards'

inputs:
  github_token:
    description: 'GitHub token'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Verify Standards
      id: verify-standards
      run: |
        set -e

        FAIL_REASON=""

        echo "Verifying documentation..."
        make docs 1>/dev/null
        DOCS_CHANGES=$(git status --porcelain)
        if [ -n "$DOCS_CHANGES" ]; then
          FAIL_REASON="${FAIL_REASON}\n"
          FAIL_REASON="${FAIL_REASON}* ❌ Documentation is out of date:\n"
          FAIL_REASON="${FAIL_REASON}  \`\`\`bash\n"
          FAIL_REASON="${FAIL_REASON}$(echo -e "$DOCS_CHANGES" | sed 's/^/  /')\n"
          FAIL_REASON="${FAIL_REASON}  \`\`\`\n"
          FAIL_REASON="${FAIL_REASON}  Please run \`make docs\` and commit the changes.\n"
        fi

        echo "Verifying code standard output usage..."
        CODE_STD_OUT_USAGE=$(grep -r -E 'fmt\.Print|os\.Stdout|os\.Stderr' ./internal | grep --invert-match '^./internal/out')
        if [ -n "$CODE_STD_OUT_USAGE" ]; then
          FAIL_REASON="${FAIL_REASON}\n"
          FAIL_REASON="${FAIL_REASON}* ❌  Found usage of \`os.Stdout\`, \`os.Stderr\` or \`fmt.Print\` in code:\n"
          FAIL_REASON="${FAIL_REASON}  \`\`\`bash\n"
          FAIL_REASON="${FAIL_REASON}$(echo -e "$CODE_STD_OUT_USAGE" | sed 's/^/  /')\n"
          FAIL_REASON="${FAIL_REASON}  \`\`\`\n"
          FAIL_REASON="${FAIL_REASON}  Please use the \`internal/out\` package for output handling instead.\n"
        fi

        echo -e "${FAIL_REASON}"
        echo -e "${FAIL_REASON}" > ${REASON_FILE}
      env:
        REASON_FILE: ${{ runner.temp }}/failed_reason.txt
      shell: bash

    - name: Comment
      run: |
        FLAGS=""

        # Determine which message to post based on validation result
        FAIL_REASON=$(cat ${REASON_FILE})
        if [ -n "$FAIL_REASON" ]; then
          echo "Standards violation detected"
          TMP_FILE=$(mktemp)
          MSG_TMPL=$(cat .github/actions/verify-standards-violation/violation-message_tmpl.md)
          eval "echo -e \"${MSG_TMPL}\"" > $TMP_FILE
          FLAGS="${FLAGS} --body-file ${TMP_FILE}"
        else
          echo "No standards violation detected"
          FLAGS="${FLAGS} --body-file .github/actions/verify-standards-violation/no-violation-message.md"
        fi

        # Check for existing comment by github-actions and edit if found
        LAST_COMMENT_ID=$(gh pr view ${{ github.event.pull_request.number }} -R kyma-project/cli --json "comments" \
          | jq --raw-output '.comments[] | select(.author.login=="github-actions") | .id')
        if [ -n "$LAST_COMMENT_ID" ]; then
          echo "Editing last comment with ID: $LAST_COMMENT_ID"
          FLAGS="${FLAGS} --edit-last"
        fi

        gh pr comment ${{ github.event.pull_request.number }} -R kyma-project/cli $FLAGS
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        REASON_FILE: ${{ runner.temp }}/failed_reason.txt
      shell: bash
